<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="referrer" content="no-referrer">
    <title>Tesla Player</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            width: 100%;
            height: 100%;
            background: #000;
            overflow: hidden;
        }

        #player-container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        /* ä¸»æ’­æ”¾å™¨ iframe (tesla-netflix.com) */
        #primary-player {
            width: 100%;
            height: 100%;
            border: none;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
        }

        /* å¤‡é€‰æ’­æ”¾å™¨å®¹å™¨ */
        #fallback-player {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 5;
            display: none;
        }

        #fallback-player.active {
            display: block;
            z-index: 10;
        }

        /* Canvas æ¸²æŸ“ */
        #video-canvas {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #000;
        }

        /* éšè—çš„ video å…ƒç´  */
        #video-source {
            display: none;
        }

        /* åŠ è½½æŒ‡ç¤ºå™¨ */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 100;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: #e50914;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            color: #fff;
            font-family: sans-serif;
            font-size: 14px;
        }

        .error {
            color: #e50914;
            text-align: center;
            font-family: sans-serif;
            padding: 20px;
        }

        /* æ§åˆ¶æ  */
        .controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.9));
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 50;
        }

        #fallback-player:hover .controls,
        .controls.visible {
            opacity: 1;
        }

        .btn-text {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            margin-right: 10px;
        }

        .btn-text:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .quality-select {
            background: rgba(0, 0, 0, 0.5);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            padding: 4px;
            margin-right: 10px;
            font-size: 12px;
            cursor: pointer;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .controls-inner {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .ctrl-btn {
            background: none;
            border: none;
            color: #fff;
            cursor: pointer;
            padding: 8px;
            font-size: 20px;
        }

        .progress-bar {
            flex: 1;
            height: 6px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            cursor: pointer;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: #e50914;
            border-radius: 3px;
            width: 0%;
            pointer-events: none;
        }

        .time-display {
            color: #fff;
            font-family: sans-serif;
            font-size: 13px;
            min-width: 90px;
            text-align: center;
        }

        /* çŠ¶æ€æç¤º */
        .status-bar {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 200;
            pointer-events: none;
        }

        .status-badge {
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            font-family: monospace;
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .status-badge.primary {
            border-left: 3px solid #00ff00;
        }

        .status-badge.fallback {
            border-left: 3px solid #ff9900;
        }

        .status-badge.error {
            border-left: 3px solid #e50914;
        }

        .hidden {
            display: none !important;
        }

        /* è®¾ç½®é¢æ¿ */
        .settings-panel {
            position: absolute;
            bottom: 60px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 15px;
            width: 250px;
            display: none;
            z-index: 100;
        }

        .settings-panel.visible {
            display: block;
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .settings-item:last-child {
            margin-bottom: 0;
        }

        .settings-label {
            color: #ddd;
        }

        .toggle-switch {
            position: relative;
            width: 40px;
            height: 20px;
            background: #555;
            border-radius: 10px;
            cursor: pointer;
            transition: 0.3s;
        }

        .toggle-switch.active {
            background: #e50914;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            background: #fff;
            border-radius: 50%;
            transition: 0.3s;
        }

        .toggle-switch.active::after {
            left: 22px;
        }

        .speed-control {
            display: flex;
            gap: 5px;
        }

        .speed-btn {
            background: #333;
            border: none;
            color: #fff;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }

        .speed-btn.active {
            background: #e50914;
        }
    </style>
</head>

<body>
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-item">
            <span class="settings-label">æ’­æ”¾é€Ÿåº¦</span>
            <div class="speed-control" id="speedControl">
                <button class="speed-btn" data-speed="0.5">0.5</button>
                <button class="speed-btn active" data-speed="1.0">1.0</button>
                <button class="speed-btn" data-speed="1.5">1.5</button>
                <button class="speed-btn" data-speed="2.0">2.0</button>
            </div>
        </div>
        <div class="settings-item">
            <span class="settings-label">è‡ªåŠ¨è·³è¿‡ç‰‡å¤´</span>
            <div class="toggle-switch" id="autoSkipIntroToggle"></div>
        </div>
        <div class="settings-item">
            <span class="settings-label">è‡ªåŠ¨è·³è¿‡ç‰‡å°¾</span>
            <div class="toggle-switch" id="autoSkipOutroToggle"></div>
        </div>
        <div class="settings-item">
            <span class="settings-label">å±è”½å¹¿å‘Š</span>
            <div class="toggle-switch" id="adBlockToggle"></div>
        </div>
    </div>
    <div id="player-container">
        <!-- çŠ¶æ€æ  -->
        <div class="status-bar">
            <div class="status-badge primary" id="statusBadge">ğŸ¬ ä¸»æ’­æ”¾å™¨åŠ è½½ä¸­...</div>
        </div>

        <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loadingText">æ­£åœ¨è¿æ¥ Tesla-Netflix æ’­æ”¾å™¨...</div>
        </div>

        <!-- ä¸»æ’­æ”¾å™¨: tesla-netflix.com -->
        <iframe id="primary-player" allow="autoplay; fullscreen; encrypted-media" allowfullscreen
            referrerpolicy="no-referrer">
        </iframe>

        <!-- å¤‡é€‰æ’­æ”¾å™¨: HLS.js + Canvas -->
        <div id="fallback-player">
            <video id="video-source" crossorigin="anonymous" playsinline></video>
            <canvas id="video-canvas"></canvas>

            <!-- æ§åˆ¶æ  -->
            <div class="controls" id="controls">
                <div class="controls-inner">
                    <button class="ctrl-btn" id="playBtn">â–¶ï¸</button>
                    <div class="progress-bar" id="progressBar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="time-display" id="timeDisplay">0:00 / 0:00</div>
                    <!-- éŸ³é‡ -->
                    <div class="control-group">
                        <button class="btn-icon" id="muteBtn">ğŸ”Š</button>
                        <input type="range" class="volume-slider" id="volumeSlider" min="0" max="1" step="0.1"
                            value="1">
                    </div>

                    <div style="flex:1"></div>

                    <!-- åŠŸèƒ½åŒº -->
                    <div class="control-group">
                        <button class="btn-icon" id="settingsBtn">âš™ï¸</button>
                        <button class="btn-text" id="skipIntroBtn" title="è·³è¿‡90ç§’">+ è·³è¿‡ç‰‡å¤´</button>
                        <select class="quality-select" id="qualitySelect" style="display:none">
                            <option value="-1">è‡ªåŠ¨ç”»è´¨</option>
                        </select>
                        <button class="btn-icon" id="fullscreenBtn">â›¶</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- HLS.js CDN (å¤‡é€‰æ–¹æ¡ˆ) -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1/dist/hls.min.js"></script>
    <script src="js/store.js"></script>

    <script>
        // ================== é…ç½® ==================
        const CONFIG = {
            // ä¸»æ’­æ”¾å™¨ URL æ¨¡æ¿
            primaryPlayerUrl: 'https://tesla-netflix.com/player/index.html?url=',
            // ä¸»æ’­æ”¾å™¨è¶…æ—¶æ—¶é—´ (ms)
            primaryTimeout: 8000,
            // è°ƒè¯•æ¨¡å¼
            debug: location.search.includes('debug')
        };

        // ================== å·¥å…·å‡½æ•° ==================
        function getParam(name) {
            const regex = new RegExp('[?&]' + name + '(=([^&#]*)| &|#|$)');
            const results = regex.exec(window.location.href);
            return results && results[2] ? decodeURIComponent(results[2]) : null;
        }

        function formatTime(sec) {
            const m = Math.floor(sec / 60);
            const s = Math.floor(sec % 60);
            return `${m}:${s.toString().padStart(2, '0')}`;
        }

        function log(msg, type = 'info') {
            if (CONFIG.debug || type === 'error') {
                console.log(`[Player:${type}]`, msg);
            }
        }

        // ================== çŠ¶æ€ç®¡ç† ==================
        const state = {
            currentPlayer: null, // 'primary' | 'fallback'
            videoUrl: getParam('url') || 'https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8',
            isPlaying: false,
            hls: null,
            animationId: null
        };

        // ================== DOM å…ƒç´  ==================
        const elements = {
            container: document.getElementById('player-container'),
            loading: document.getElementById('loading'),
            loadingText: document.getElementById('loadingText'),
            statusBadge: document.getElementById('statusBadge'),
            primaryPlayer: document.getElementById('primary-player'),
            fallbackPlayer: document.getElementById('fallback-player'),
            video: document.getElementById('video-source'),
            canvas: document.getElementById('video-canvas'),
            playBtn: document.getElementById('playBtn'),
            muteBtn: document.getElementById('muteBtn'),
            fullscreenBtn: document.getElementById('fullscreenBtn'),
            progressBar: document.getElementById('progressBar'),
            progressFill: document.getElementById('progressFill'),
            timeDisplay: document.getElementById('timeDisplay'),
            controls: document.getElementById('controls')
        };

        const ctx = elements.canvas.getContext('2d');

        // ================== ä¸»æ’­æ”¾å™¨ (tesla-netflix.com) ==================
        function initPrimaryPlayer() {
            log('å°è¯•åŠ è½½ä¸»æ’­æ”¾å™¨: tesla-netflix.com');
            updateStatus('ğŸ¬ ä¸»æ’­æ”¾å™¨åŠ è½½ä¸­...', 'primary');
            elements.loadingText.textContent = 'æ­£åœ¨è¿æ¥ Tesla-Netflix æ’­æ”¾å™¨...';

            const playerUrl = CONFIG.primaryPlayerUrl + encodeURIComponent(state.videoUrl);
            elements.primaryPlayer.src = playerUrl;

            // è®¾ç½®è¶…æ—¶æ£€æµ‹
            const timeout = setTimeout(() => {
                log('ä¸»æ’­æ”¾å™¨è¶…æ—¶ï¼Œåˆ‡æ¢åˆ°å¤‡é€‰æ–¹æ¡ˆ', 'warn');
                switchToFallback('åŠ è½½è¶…æ—¶');
            }, CONFIG.primaryTimeout);

            // ç›‘å¬ iframe åŠ è½½
            elements.primaryPlayer.onload = () => {
                clearTimeout(timeout);

                // æ£€æµ‹æ˜¯å¦çœŸæ­£åŠ è½½æˆåŠŸï¼ˆé€šè¿‡ä¸€äº›å¯å‘å¼æ–¹æ³•ï¼‰
                try {
                    // ç”±äºè·¨åŸŸé™åˆ¶ï¼Œæ— æ³•ç›´æ¥æ£€æµ‹å†…å®¹
                    // ä½†å¦‚æœ onload è§¦å‘ï¼Œè¯´æ˜ iframe å·²åŠ è½½
                    log('ä¸»æ’­æ”¾å™¨ iframe å·²åŠ è½½');

                    // ç»™æ’­æ”¾å™¨ä¸€äº›æ—¶é—´åˆå§‹åŒ–
                    setTimeout(() => {
                        onPrimaryReady();
                    }, 1500);
                } catch (e) {
                    log('ä¸»æ’­æ”¾å™¨æ£€æµ‹å¤±è´¥: ' + e.message, 'error');
                    switchToFallback('æ£€æµ‹å¤±è´¥');
                }
            };

            elements.primaryPlayer.onerror = () => {
                clearTimeout(timeout);
                log('ä¸»æ’­æ”¾å™¨åŠ è½½é”™è¯¯', 'error');
                switchToFallback('åŠ è½½é”™è¯¯');
            };
        }

        function onPrimaryReady() {
            state.currentPlayer = 'primary';
            elements.loading.classList.add('hidden');
            updateStatus('âœ… Tesla-Netflix æ’­æ”¾å™¨', 'primary');
            log('ä¸»æ’­æ”¾å™¨å°±ç»ª');

            // 3ç§’åéšè—çŠ¶æ€æç¤º
            setTimeout(() => {
                elements.statusBadge.classList.add('hidden');
            }, 3000);
        }

        // ================== å¤‡é€‰æ’­æ”¾å™¨ (HLS.js + Canvas) ==================
        function switchToFallback(reason) {
            log(`åˆ‡æ¢åˆ°å¤‡é€‰æ’­æ”¾å™¨: ${reason}`);
            updateStatus(`âš ï¸ å¤‡é€‰æ’­æ”¾å™¨ (${reason})`, 'fallback');
            elements.loadingText.textContent = 'æ­£åœ¨å¯åŠ¨å¤‡é€‰æ’­æ”¾å™¨...';

            // éšè—ä¸»æ’­æ”¾å™¨ï¼Œæ˜¾ç¤ºå¤‡é€‰
            elements.primaryPlayer.src = '';
            elements.primaryPlayer.classList.add('hidden');
            elements.fallbackPlayer.classList.add('active');

            initFallbackPlayer();
        }

        function initFallbackPlayer() {
            state.currentPlayer = 'fallback';
            log(`å¤‡é€‰æ’­æ”¾å™¨åŠ è½½è§†é¢‘: ${state.videoUrl.substring(0, 60)}...`);

            if (Hls.isSupported()) {
                state.hls = new Hls({
                    debug: CONFIG.debug,
                    enableWorker: true,
                    lowLatencyMode: false,
                });

                state.hls.loadSource(state.videoUrl);
                state.hls.attachMedia(elements.video);

                state.hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    log('HLS æ¸…å•è§£æå®Œæˆ');

                    // åˆå§‹åŒ–ç”»è´¨é€‰æ‹©å™¨
                    if (state.hls.levels.length > 1) {
                        const select = document.getElementById('qualitySelect');
                        select.style.display = 'block';
                        select.innerHTML = '<option value="-1">è‡ªåŠ¨ (Auto)</option>';
                        state.hls.levels.forEach((level, index) => {
                            const opt = document.createElement('option');
                            opt.value = index;
                            opt.text = `${level.height}P`;
                            select.appendChild(opt);
                        });
                        select.onchange = (e) => {
                            state.hls.currentLevel = parseInt(e.target.value);
                            log(`ç”»è´¨åˆ‡æ¢: ${e.target.value === '-1' ? 'Auto' : state.hls.levels[e.target.value].height + 'P'}`);
                        };
                    }

                    elements.loadingText.textContent = 'å‡†å¤‡æ’­æ”¾...';
                    playFallbackVideo();
                });

                state.hls.on(Hls.Events.ERROR, (event, data) => {
                    if (data.fatal) {
                        log('HLS è‡´å‘½é”™è¯¯: ' + data.type, 'error');
                        showError('è§†é¢‘åŠ è½½å¤±è´¥: ' + data.type);
                    }
                });

            } else if (elements.video.canPlayType('application/vnd.apple.mpegurl')) {
                // Safari åŸç”Ÿæ”¯æŒ
                elements.video.src = state.videoUrl;
                elements.video.addEventListener('loadedmetadata', playFallbackVideo);
            } else {
                showError('æµè§ˆå™¨ä¸æ”¯æŒ HLS æ’­æ”¾');
            }
        }

        async function playFallbackVideo() {
            try {
                await elements.video.play();
                state.isPlaying = true;
                elements.playBtn.textContent = 'â¸ï¸';
                elements.loading.classList.add('hidden');
                updateStatus('âœ… Canvas æ’­æ”¾å™¨', 'fallback');
                renderFrame();
                renderFrame();
                log('å¤‡é€‰æ’­æ”¾å™¨æ’­æ”¾ä¸­ (Canvas æ¸²æŸ“)');

                // æ£€æŸ¥æ˜¯å¦éœ€è¦æ¢å¤è¿›åº¦
                checkResume();

                setTimeout(() => {
                    elements.statusBadge.classList.add('hidden');
                }, 3000);
            } catch (err) {
                log('è‡ªåŠ¨æ’­æ”¾å¤±è´¥: ' + err.message, 'warn');
                elements.controls.classList.add('visible');
                elements.loading.classList.add('hidden');
            }
        }

        // Canvas æ¸²æŸ“å¾ªç¯
        function renderFrame() {
            if (elements.video.readyState >= 2) {
                if (elements.canvas.width !== elements.video.videoWidth) {
                    elements.canvas.width = elements.video.videoWidth || 1920;
                    elements.canvas.height = elements.video.videoHeight || 1080;
                }
                ctx.drawImage(elements.video, 0, 0, elements.canvas.width, elements.canvas.height);
            }

            if (state.isPlaying) {
                state.animationId = requestAnimationFrame(renderFrame);
            }
        }

        // ================== UI æ›´æ–° ==================
        function updateStatus(text, type) {
            elements.statusBadge.textContent = text;
            elements.statusBadge.className = 'status-badge ' + type;
            elements.statusBadge.classList.remove('hidden');
        }

        function showError(msg) {
            elements.loading.innerHTML = `<div class="error">âŒ ${msg}</div>`;
        }

        function updateProgress() {
            if (elements.video.duration) {
                const percent = (elements.video.currentTime / elements.video.duration) * 100;
                elements.progressFill.style.width = percent + '%';
                elements.timeDisplay.textContent =
                    `${formatTime(elements.video.currentTime)} / ${formatTime(elements.video.duration)}`;
            }
        }

        // ================== æ§åˆ¶äº‹ä»¶ ==================
        function togglePlay() {
            if (state.currentPlayer !== 'fallback') return;

            if (state.isPlaying) {
                elements.video.pause();
                state.isPlaying = false;
                elements.playBtn.textContent = 'â–¶ï¸';
                if (state.animationId) cancelAnimationFrame(state.animationId);
            } else {
                playFallbackVideo();
            }
        }

        function toggleMute() {
            if (state.currentPlayer !== 'fallback') return;
            elements.video.muted = !elements.video.muted;
            elements.muteBtn.textContent = elements.video.muted ? 'ğŸ”‡' : 'ğŸ”Š';
        }

        function toggleFullscreen() {
            if (document.fullscreenElement) {
                document.exitFullscreen();
            } else {
                elements.container.requestFullscreen();
            }
        }

        function seekTo(e) {
            if (state.currentPlayer !== 'fallback') return;
            const rect = elements.progressBar.getBoundingClientRect();
            const percent = (e.clientX - rect.left) / rect.width;
            elements.video.currentTime = percent * elements.video.duration;
        }

        // ================== äº‹ä»¶ç»‘å®š ==================
        elements.playBtn.addEventListener('click', togglePlay);
        elements.muteBtn.addEventListener('click', toggleMute);
        elements.fullscreenBtn.addEventListener('click', toggleFullscreen);
        elements.progressBar.addEventListener('click', seekTo);
        elements.video.addEventListener('timeupdate', updateProgress);
        elements.video.addEventListener('ended', () => {
            state.isPlaying = false;
            elements.playBtn.textContent = 'â–¶ï¸';
        });

        // ================== è®¾ç½®åŠŸèƒ½é€»è¾‘ ==================
        const settings = {
            panel: document.getElementById('settingsPanel'),
            btn: document.getElementById('settingsBtn'),
            toggles: {
                intro: document.getElementById('autoSkipIntroToggle'),
                outro: document.getElementById('autoSkipOutroToggle'),
                ad: document.getElementById('adBlockToggle')
            },
            speed: document.getElementById('speedControl')
        };

        // åŠ è½½åˆå§‹è®¾ç½®
        function loadSettings() {
            if (!window.store) return;
            const conf = window.store.getSettings();

            // æ¸²æŸ“ Toggles
            if (conf.skipIntro) settings.toggles.intro.classList.add('active');
            if (conf.autoSkipOutro) settings.toggles.outro.classList.add('active');
            if (conf.adBlock) settings.toggles.ad.classList.add('active');

            // æ¸²æŸ“ Speed
            document.querySelectorAll('.speed-btn').forEach(btn => {
                btn.classList.remove('active');
                if (parseFloat(btn.dataset.speed) === conf.speed) btn.classList.add('active');
            });
            elements.video.playbackRate = conf.speed || 1.0;
        }

        // ç»‘å®šè®¾ç½®äº‹ä»¶
        settings.btn.onclick = () => settings.panel.classList.toggle('visible');

        function toggleSetting(key, el) {
            el.classList.toggle('active');
            const val = el.classList.contains('active');
            window.store.updateSettings({ [key]: val });
            updateStatus(` è®¾ç½®æ›´æ–°: ${key} = ${val ? 'å¼€' : 'å…³'}`, 'primary');
        }

        settings.toggles.intro.onclick = () => toggleSetting('skipIntro', settings.toggles.intro);
        settings.toggles.outro.onclick = () => toggleSetting('autoSkipOutro', settings.toggles.outro);
        settings.toggles.ad.onclick = () => toggleSetting('adBlock', settings.toggles.ad);

        settings.speed.onclick = (e) => {
            if (e.target.classList.contains('speed-btn')) {
                const speed = parseFloat(e.target.dataset.speed);
                document.querySelectorAll('.speed-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                elements.video.playbackRate = speed;
                window.store.updateSettings({ speed: speed });
                updateStatus(`ğŸš€ æ’­æ”¾é€Ÿåº¦: ${speed}x`, 'primary');
            }
        };

        // è‡ªåŠ¨è·³è¿‡æ£€æµ‹ (åœ¨ updateProgress ä¸­è°ƒç”¨)
        function checkAutoSkip() {
            if (!window.store) return;
            const conf = window.store.getSettings();
            const time = elements.video.currentTime;
            const duration = elements.video.duration;

            // è‡ªåŠ¨è·³è¿‡ç‰‡å¤´ (å‡è®¾ç‰‡å¤´åœ¨ 0-90s ä¹‹é—´ï¼Œä¸”åªè§¦å‘ä¸€æ¬¡)
            // è¿™é‡Œé€»è¾‘ç®€åŒ–ï¼šå¦‚æœå¼€å¯ä¸”åœ¨å‰5ç§’ï¼Œç›´æ¥è·³è¿‡ (æ¨¡æ‹Ÿ)
            // å®é™…åº”è®°å½• state.hasSkippedIntro
            if (conf.skipIntro && time < 2 && !state.hasSkippedIntro) {
                elements.video.currentTime += 90;
                state.hasSkippedIntro = true;
                updateStatus('â© è‡ªåŠ¨è·³è¿‡ç‰‡å¤´', 'primary');
            }

            // è‡ªåŠ¨è·³è¿‡ç‰‡å°¾ (æœ€å 60ç§’)
            if (conf.autoSkipOutro && duration > 0 && (duration - time) < 60 && !state.hasSkippedOutro) {
                // æš‚æ—¶åªæç¤ºï¼Œä¸ç›´æ¥åˆ‡ä¸‹ä¸€é›†(å› ä¸ºå¤ªå¤æ‚)
                updateStatus('â­ï¸ å³å°†è‡ªåŠ¨ç»“æŸ...', 'primary');
                state.hasSkippedOutro = true; // é˜²æ­¢é‡å¤è§¦å‘
            }
        }

        // åˆå§‹åŒ–æ—¶è°ƒç”¨
        loadSettings();

        // è·³è¿‡ç‰‡å¤´
        document.getElementById('skipIntroBtn').addEventListener('click', () => {
            elements.video.currentTime += 90;
            updateStatus('â© å·²è·³è¿‡ç‰‡å¤´ (+90s)', 'primary');
        });

        // é”®ç›˜æ§åˆ¶
        document.addEventListener('keydown', (e) => {
            if (e.key === ' ' || e.key === 'k') togglePlay();
            if (e.key === 'm') toggleMute();
            if (e.key === 'f') toggleFullscreen();
            if (e.key === 'ArrowRight') elements.video.currentTime += 10;
            if (e.key === 'ArrowLeft') elements.video.currentTime -= 10;
        });

        // è§¦æ‘¸æ˜¾ç¤ºæ§åˆ¶æ 
        elements.fallbackPlayer.addEventListener('touchstart', () => {
            elements.controls.classList.add('visible');
            setTimeout(() => elements.controls.classList.remove('visible'), 3000);
        });

        // ================== åˆå§‹åŒ– ==================
        log(`è§†é¢‘ URL: ${state.videoUrl}`);
        log(`å¹³å°: ${navigator.platform}, UA: ${navigator.userAgent.substring(0, 50)}...`);

        // å†å²è®°å½•å…ƒæ•°æ®
        state.meta = {
            id: getParam('id'),
            name: getParam('name'),
            pic: getParam('pic')
        };

        // åˆå§‹åŒ–ä¸»æ’­æ”¾å™¨
        initPrimaryPlayer();

        // å°è¯•è®°å½•åˆå§‹å†å² (æ›´æ–°è®¿é—®æ—¶é—´)
        if (state.meta.id && window.store) {
            const existing = window.store.getHistory(state.meta.id);
            window.store.saveHistory(state.meta.id, {
                time: existing ? existing.time : 0,
                duration: existing ? existing.duration : 0,
                title: state.meta.name,
                pic: state.meta.pic
            });
        }

        // å¤‡é€‰æ’­æ”¾å™¨è¿›åº¦ä¿å­˜å¾ªç¯
        setInterval(() => {
            if (state.currentPlayer === 'fallback' && state.isPlaying && state.meta.id && window.store) {
                const time = elements.video.currentTime;
                const duration = elements.video.duration;
                if (time > 5) { // æ’­æ”¾è¶…è¿‡5ç§’æ‰è®°å½•
                    window.store.saveHistory(state.meta.id, {
                        time: time,
                        duration: duration,
                        title: state.meta.name,
                        pic: state.meta.pic
                    });
                }
            }
        }, 5000);

        // å¤‡é€‰æ’­æ”¾å™¨æ¢å¤æ’­æ”¾é€»è¾‘ (åœ¨ playFallbackVideo ä¸­è°ƒç”¨)
        function checkResume() {
            if (state.meta.id && window.store) {
                const history = window.store.getHistory(state.meta.id);
                if (history && history.time > 10 && (history.duration - history.time > 60)) {
                    // è¯¢é—®æˆ–è‡ªåŠ¨è·³è½¬ (è¿™é‡Œç®€å•å¤„ç†ï¼šæ˜¾ç¤ºæç¤ºå¹¶è·³è½¬)
                    log(`æ¢å¤æ’­æ”¾: ${formatTime(history.time)}`);
                    elements.video.currentTime = history.time;
                    updateStatus(`ğŸ”„ æ¢å¤è‡³ ${formatTime(history.time)}`, 'primary'); // å¤ç”¨æ ·å¼
                }
            }
        }
    </script>
</body>

</html>